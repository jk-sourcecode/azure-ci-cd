import groovy.json.JsonSlurper

node {

    def PACKAGE_VERSION = sh(returnStdout: true, script: /sed -nE 's\/^\s*"version": "(.*?)",$\/\1\/p' package.json/).trim()   
    
    stage('Pull') {
          environment {
        // 'This value is exported to all commands in this stage'
        testPath = "${env.devjwtapi-acr-path}"
      }
        echo """${testPath}"""
        checkout scm
    }

    stage('Build') {
        echo 'Building docker image'
        echo """version-${PACKAGE_VERSION}"""
        sh """docker build -t devjwtapi.azurecr.io/secure-api-jwt:version-${PACKAGE_VERSION} ."""
    }
    
    stage('Publish') {
        sh "docker login -u devjwtapi -p =6zDPwQLXgMQEcJRHKEzYvLZEp61VDL3 devjwtapi.azurecr.io"
        sh """docker push devjwtapi.azurecr.io/secure-api-jwt:version-${PACKAGE_VERSION}"""
    }
}